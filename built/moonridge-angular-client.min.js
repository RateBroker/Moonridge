angular.module("RPC",[]).factory("$rpc",["$rootScope","$log","$q",function(a,b,c){function d(a){return"SIORPC:"+f+"/"+a}function e(a,c){try{localStorage[a]=JSON.stringify(c)}catch(d){b.warn("Error raised when writing to local storage: "+d)}}var f,g,h,i=0,j=0,k={},l={},m=[],n={},o=c.defer();o.promise.then(function(a){h=new Date(a)});var p=function(a){m[a]?(delete m[a],j++,u.onEnd(j),j==i&&(u.onBatchEnd(j),i=0,j=0)):b.warn("Deferred Id "+a+" was resolved/rejected more than once, this should not occur.")},q=function(a,b,c){k.hasOwnProperty(a)||(k[a]={});var e=k[a];return e._loadDef=c,e._handshake=b,o.promise.then(function(){var c=d(a),f=localStorage[c];f?(f=JSON.parse(f),h<new Date(f.cDate)?b?(g.emit("authenticate",{name:a,handshake:b}),e.cached=f):(s(e,a),r(f,!1)):(delete localStorage[c],g.emit("load channel",{name:a,handshake:b}))):g.emit("load channel",{name:a,handshake:b})}),e._loadDef.promise},r=function(b,f){var g=k[b.name],h=function(a){g[a]=function(){return i++,g._socket.emit("call",{Id:i,fnName:a,args:Array.prototype.slice.call(arguments,0)}),1==i&&u.onBatchStarts(i),u.onCall(i),m[i]=c.defer(),m[i].promise}};b.fnNames?(b.tplId&&(n[b.tplId]=b.fnNames),b.fnNames.forEach(h)):n[b.tplId].forEach(h),g._loadDef.resolve(g),f!==!1&&(a.$apply(),b.cDate=new Date,e(d(b.name),b))},s=function(a,d){var e=c.defer();a._socket||(a._socket=io.connect(f+"/rpc-"+d).on("resolve",function(a){m[a.Id].resolve(a.value),p(a.Id)}).on("reject",function(a){a&&a.Id?(m[a.Id].reject(a.reason),b.error("Call "+a.Id+" is rejected, reason ",a.reason),p(a.Id)):b.error("Unknown error occured on RPC socket connection")}).on("connectFailed",function(c){b.error("unable to connect to namespace ",c),a._loadDef.reject(c)}).on("disconnect",function(){a._loadDef=e,b.warn("Server channel "+d+" disconnected.")}).on("reconnect",function(){b.info("reconnected channel"+d),q(d,a._handshake,e)}))},t=function(d,e){return!g&&d?(f=d,g=io.connect(d+"/rpc-master",e).on("serverRunDate",function(b){o.resolve(b),a.$apply()}).on("authenticated",function(a){var b=a.name,c=k[b];s(c,b),r(c.cached,!1)}).on("channelFns",function(a,b){var c=a.name,d=k[c];s(d,c),r(a,b)}).on("channelDoesNotExist",function(c){var d=k[c.name];d._loadDef.reject(),b.warn("no channel under name: "+c.name),a.$apply()}).on("clientChannelCreated",function(a){var b=l[a],d=io.connect(f+"/rpcC-"+a+"/"+g.io.engine.id);b._socket=d,d.on("call",function(a){var e=b.fns;if(e.hasOwnProperty(a.fnName)&&"function"==typeof e[a.fnName]){var f=e[a.fnName].apply(this,a.args);c.when(f).then(function(b){b instanceof Error?d.emit("reject",{Id:a.Id,reason:b.toString()}):d.emit("resolve",{Id:a.Id,value:b})},function(b){b instanceof Error&&(b=b.toString()),d.emit("reject",{Id:a.Id,reason:b})})}else d.emit("reject",{Id:a.Id,reason:"no such function has been exposed: "+a.fnName})}),b.deferred.resolve(b)})):void b.warn("ignoring connect command, either url of master null or already connected")},u={connect:t,loadAllChannels:function(){return g?(g.__channelListLoad=c.defer(),g.emit("load channelList"),g.on("channels",function(b){for(var c=b.list.pop();c;)k[c]={},q(c),c=b.list.pop();g.__channelListLoad.resolve(k),a.$apply()}),g.__channelListLoad.promise):void b.error("no connection to master")},loadChannel:function(a,b){if(k.hasOwnProperty(a))return k[a]._loadDef.promise;var d=c.defer();return q(a,b,d),d.promise},expose:function(a,b){if(l.hasOwnProperty(a))return l[a].deferred.promise;l[a]={};var d=l[a];d.fns=b,d.deferred=c.defer();var e=[];for(var f in b){if("_socket"===f)throw new Error("Failed to expose channel, _socket property is reserved for socket namespace");e.push(f)}var h=function(){g.emit("exposeChannel",{name:a,fns:e})};return g.connected&&h(),g.on("disconnect",function(){d.deferred=c.defer()}).on("connect",h).on("reexposeChannels",h),d.deferred.promise}},v=angular.noop;return u.onBatchStarts=v,u.onBatchEnd=v,u.onCall=v,u.onEnd=v,u.auth={},u}]).directive("rpcController",["$controller","$q","$rpc",function(a,b,c){return{scope:!0,compile:function(){return{pre:function(d,e,f){if(!f.rpcChannel)throw new Error("No channel name defined on rpc-controller element: "+e[0].outerHTML);var g=f.rpcController,h=function(b){b.then(function(b){var c={$scope:d};c[f.rpcChannel]=b;var h=a(g,c);e.children().data("$ngControllerController",h)},function(){$log.error("Cannot instantiate rpc-controller - channel failed to load")})};if(f.rpcAuth){var i=c.auth[f.rpcAuth];if("function"!=typeof i)throw new Error("no auth getter function found under "+f.rpcAuth);b.when(i()).then(function(a){var b=c.loadChannel(f.rpcChannel,a);h(b)})}else{var j=c.loadChannel(f.rpcChannel);h(j)}}}}}}]),angular.module("Moonridge",["RPC"]).factory("$MR",["$rootScope","$rpc","QueryChainable","$q","$log",function(a,b,c,d,e){var f,g={},h=function(a,h,i){function j(a){return e.error(a),d.reject(a)}function k(a){var b=this,f=0;this.name=a,this._LQs={},this._LQsByQuery={},this.deferred=d.defer(),this.update=function(a){return delete a.$$hashKey,b.rpc.update(a).catch(j)},this.create=function(a){return delete a.$$hashKey,b.rpc.create(a).catch(j)},this.remove=function(a){return b.rpc.remove(a._id).catch(j)},this.listPaths=function(){return b.rpc.listPaths().catch(j)},this.query=function(){var a={query:[],indexedByMethods:{}};return new c(a,function(){var c=function(){a.promise=b.rpc.query(a.query).then(function(b){a.indexedByMethods.findOne?a.doc=b:a.docs=b})};return a.exec=c,c(),a},b)};var g=function(a){return function(c,d,f){var g=b._LQs[c];g?(g["on_"+a](d,f),g._invokeListeners(a,arguments)):e.error("Unknown liveQuery calls this clients pub method, LQ id: "+c)}};this.clientRPCMethods={update:g("update"),remove:g("remove"),create:g("create"),push:g("push")},this.liveQuery=function(a){a&&a.stop();var d={_model:b,docs:[],count:0};"function"==typeof Object.defineProperty&&Object.defineProperty(d,"doc",{enumerable:!1,configurable:!1,get:function(){return d.docs[0]}});var g={update:[],remove:[],create:[],push:[],init:[],any:[]};d._invokeListeners=function(a,b){"any"!==a&&this._invokeListeners("any",b);for(var c=g[a].length;c--;)g[a][c].call(d,b)},d.on=function(a,b){return g[a].push(b)-1},d.off=function(a,b){return g[a][b]?(delete g[a][b],!0):!1},angular.isObject(a)?(d.query=a.query,d.indexedByMethods=a.indexedByMethods):(d.query=[],d.indexedByMethods={}),d.getDocById=function(a){for(var b=d.docs.length;b--;)if(d.docs[b]._id===a)return d.docs[b];return null},d.recountIfNormalQuery=function(){d.indexedByMethods.count||(d.count=d.docs.length)},d.on_create=function(a,b){d.promise.then(function(){return d.indexedByMethods.count?void(d.count+=1):(angular.isNumber(b)?d.docs.splice(b,0,a):d.docs.push(a),d.indexedByMethods.limit<d.docs.length&&d.docs.splice(d.docs.length-1,1),void d.recountIfNormalQuery())})},d.on_push=d.on_create,d.on_update=function(a,b){d.promise.then(function(){if(d.indexedByMethods.count)return void(angular.isNumber(b)?d.count+=1:(b===!1&&(d.count-=1),b===!0&&(d.count+=1)));for(var c=d.docs.length;c--;){var f;if(d.docs[c]._id===a._id)return b===!1?void d.docs.splice(c,1):void(angular.isNumber(b)&&b!==c?b>c?(d.docs.splice(c,1),d.docs.splice(b-1,0,a)):(d.docs.splice(c,1),d.docs.splice(b,0,a)):(f=d.docs[c],angular.extend(f,a)))}return b?void(angular.isNumber(b)?d.docs.splice(b,0,a):d.docs.push(a)):(e.error("Failed to find updated document."),void d.recountIfNormalQuery())})},d.on_remove=function(a){d.promise.then(function(){if(d.indexedByMethods.count)return d.count-=1,!0;for(var b=d.docs.length;b--;)if(d.docs[b]._id===a)return d.docs.splice(b,1),d.count-=1,!0;return e.error("Failed to find deleted document."),!1})},d.stop=function(){if(!angular.isNumber(d.index)||!b._LQs[d.index])throw new Error("There must be a valid index property, when stop is called");d.stopped=!0,b.rpc.unsubLQ(d.index).then(function(a){a&&(d.indexedByMethods.count?d.count=0:(d.doc=null,d.docs=[]),delete b._LQs[d.index],delete b._LQsByQuery[d._queryStringified])})};var h=function(a){if(!d._queryStringified){if(d.indexedByMethods.hasOwnProperty("count")&&d.indexedByMethods.hasOwnProperty("sort"))throw new Error("count and sort must NOT be used on the same query");if(d._queryStringified=JSON.stringify(d.query),b._LQsByQuery[d._queryStringified]&&b._LQsByQuery[d._queryStringified].stopped!==!0)return b._LQsByQuery[d._queryStringified];b._LQsByQuery[d._queryStringified]=d,f+=1,b._LQs[f]=d,d.index=f}return d.promise=b.rpc.liveQuery(d.query,d.index).then(function(b){if(angular.isNumber(b.count))d.count+=b.count;else{var c=b.docs.length;for(d.count+=c;c--;)d.docs[c]=b.docs[c]}return d._invokeListeners("init",b),a?d.stopped=!1:(l.socket.on("disconnect",function(){d.stopped=!0}),l.socket.on("reconnect",function(){d.docs=[],d.count=0,h(!0)})),d},j),d};return new c(d,h,b)}}var l;if(g[a])return g[a];l={},g[a]=l;var m={};return l.connectPromise=d.when(h).then(function(a){var c=b.connect(a.url,a.hs);return l.socket=c,c}),l.getAllModels=function(){b.loadChannel("Moonridge").then(function(a){a.getModels().then(function(){})})},l.getModel=function(a,c){var e=m[a];return e?e.deferred.promise:(e=new k(a),m[a]=e,l.connectPromise.then(function(){var f={client:b.expose("MR-"+a,e.clientRPCMethods),server:b.loadChannel("MR-"+a,c)};d.all(f).then(function(a){e.rpc=a.server,e.deferred.resolve(e)}),l.socket.on("disconnect",function(){console.log("model disconnect"),e.deferred=d.defer()}),l.socket.on("reconnect",function(){console.log("model reconnect");var f={client:b.expose("MR-"+a,e.clientRPCMethods),server:b.loadChannel("MR-"+a,c)};d.all(f).then(function(a){console.log("model reconnect resolve both client and server channel"),e.rpc=a.server,e.deferred.resolve(e)})})}),e.deferred.promise)},l.getModels=function(a,b){for(var c={},e=a.length;e--;){var f=a[e];c[f]=l.getModel(f,b)}return d.all(c)},i&&(f=l),l};return h.getBackend=function(a){if(g[a])return g[a];throw new Error("no such Moonridge backend")},h.getDefaultBackend=function(){return f},h}]),angular.module("Moonridge").factory("MRMethodsClientValidations",function(){function a(a){return"number"==typeof a&&a%1==0}var b=function(){return!0},c=function(b){return 1===b.length?a(b[0])?!0:new TypeError("Argument must be an integer"):new Error("Method must be called with exactly one Number argument")},d={all:b,and:b,box:b,center:b,centerSphere:b,circle:b,comment:b,count:b,elemMatch:b,equals:b,exists:b,find:b,findOne:function(a){return 0===a.length?!0:a.length>1?new Error("FindOne does not take more than one argument"):"object"!=typeof a[0]?new TypeError("FindOne takes just one Object as argument"):!0},geometry:b,gt:b,gte:b,hint:b,"in":b,intersects:b,limit:c,lt:b,lte:b,maxDistance:b,maxScan:c,mod:b,ne:b,near:b,nearSphere:b,nin:b,nor:b,or:b,polygon:b,populate:b,read:b,regex:b,select:b,size:b,skip:c,slice:b,sort:b,where:function(a){return a.length>0&&a.length<=2?!0:new Error("Method was called with wrong number of arguments")},within:b};return d}),angular.module("Moonridge").factory("QueryChainable",["MRMethodsClientValidations",function(a){function b(b,d,e){var f=this;this.exec=d,this._model=e;var g=Array.prototype.slice,h=function(d){f[d]=function(){var e=g.call(arguments),h=a[d](e);if(h instanceof Error)throw h;var i=b.query;if(-1!==c.indexOf(d)){if(b.indexedByMethods[d])for(var j=i.length;j--;)i[j].mN===d&&i.splice(j,1);b.indexedByMethods[d]=e}return i.push({mN:d,args:e}),f}};for(var i in a)h(i)}var c=["findOne","select","count","sort","limit","skip"];return b}]),angular.module("Moonridge").directive("mrController",["$controller","$q","$MR",function(a,b,c){var d=function(a){throw new Error("Cannot instantiate mr-controller - error: "+a)};return{scope:!0,compile:function(){return{pre:function(b,e,f){var g,h=f.mrController;g=f.mrBackend?c.getBackend(f.mrBackend):c.getDefaultBackend();var i=f.mrModels,j=function(c){b.$on("$destroy",function(){});var d={$scope:b};-1!==i.indexOf(",")?angular.extend(d,c):d[i]=c;var f=a(h,d);e.children().data("$ngControllerController",f)};if(void 0===i)throw new Error("No Moonridge models defined on element: "+el);-1!==i.indexOf(",")?g.getModels(i.split(",")).then(j,d):g.getModel(i).then(j,d)}}}}}]).directive("mrRepeat",["$compile","mrSpinner",function(a,b){var c="_id";return{compile:function(d){var e=d.html();return d.html(b),function(b,d,f){function g(c){d.removeAttr("mr-repeat"),m?d.attr("ng-repeat",h+".docs"+i+l):(d.attr("ng-repeat",h+i+l),b[k]=c),d.html(e),a(d)(b),m&&!f.noStopping&&b.$on("$destroy",function(){m.stop()})}var h=f.mrRepeat,i="";-1!==h.indexOf("|")&&(i=" |"+h.split("|")[1],h=h.split("|")[0].trim());var j=h.split(" in ")[0],k=h.split(" in ")[1],l="";-1===h.indexOf("track by")&&(l=" track by "+j+"."+c);var m;b.$watch(k,function(a){a&&(a.promise?(m=a,a.promise.then(g)):a.then&&a.then(g))})}}}}]).value("mrSpinner",'<div class="spinner"><div class="rect1"></div><div class="rect2"></div><div class="rect3"></div><div class="rect4"></div><div class="rect5"></div></div>'),angular.module("Moonridge").run(["$templateCache",function(a){"use strict";a.put("moonridge_query_dropdown.html",'<div class="moonridge-query-dropdown btn-group">\r\n    <a class="btn btn-default dropdown-toggle" data-toggle="dropdown">\r\n        Sort and filter <span class="caret"></span>\r\n    </a>\r\n    <ul class="dropdown-menu" role="menu">\r\n        <li ng-repeat="path in paths">\r\n            <div class="row" ng-if="mrDropdown_guiPathTexts[$index] !== false">\r\n                <div class="col-md-4">\r\n                    <span ng-class="{active: getSortTokens().indexOf(\'-\' + path) !== -1}"\r\n                            class="glyphicon glyphicon-sort-by-attributes-alt" ng-click="sortBy(\'-\' + path, $event)"></span>\r\n                    <span ng-class="{active: getSortTokens().indexOf(path) !== -1}"\r\n                            class="glyphicon glyphicon-sort-by-attributes" ng-click="sortBy(path, $event)"></span>\r\n                </div>\r\n                <div class="col-md-8">\r\n                    <a ng-bind="mrDropdown_guiPathTexts[$index] || path" ng-click="switchSort(path)"></a>\r\n                </div>\r\n            </div>\r\n        </li>\r\n    </ul>\r\n</div>')}]),angular.module("Moonridge").directive("mrQueryDropdown",["$log",function(a){return{restrict:"EA",templateUrl:"moonridge_query_dropdown.html",link:function(b,c,d){var e,f=d.query;b.$watch(f,function(c){c&&c._model&&c._model.rpc&&(b.mrDropdown_guiPathTexts=b.$eval(d.guiPathTexts),e!==c._model.name&&(e=c._model.name,c._model.rpc.listPaths().then(function(c){a.log("mrQueryDropdown",c),b.paths=c}),b.getSortTokens=function(){return b[f].indexedByMethods.sort[0].split(" ")},b.sortBy=function(d,e){if(a.log(d,e),e.shiftKey);else{var g=c._model.liveQuery(b[f]);b[f]=g.sort(d).exec()}}))})}}}]);