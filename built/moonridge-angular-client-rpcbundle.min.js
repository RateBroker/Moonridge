angular.module("RPC",[]).factory("$rpc",["$rootScope","$q",function(a,b){function c(a){return"SIORPC:"+e+"/"+a}function d(a,b){try{localStorage[a]=JSON.stringify(b)}catch(c){console.warn("Error raised when writing to local storage: "+c)}}var e,f,g,h=0,i=0,j={},k={},l=[],m=b.defer();m.promise.then(function(a){g=new Date(a)});var n=function(a){l[a]?(delete l[a],i++,s.onEnd(i),i==h&&(s.onBatchEnd(i),h=0,i=0)):console.warn("Deferred Id "+a+" was resolved/rejected more than once, this should not occur.")},o=function(a,b,d){j.hasOwnProperty(a)||(j[a]={});var e=j[a];return e._loadDef=d,m.promise.then(function(){var d=c(a),h=localStorage[d];h?(h=JSON.parse(h),g<new Date(h.cDate)?b?(f.emit("authenticate",{name:a,handshake:b}),e.cached=h):(q(e,a),p(h,!1)):(delete localStorage[d],f.emit("load channel",{name:a,handshake:b}))):f.emit("load channel",{name:a,handshake:b})}),e._loadDef.promise},p=function(e,f){var g=j[e.name];e.fnNames.forEach(function(a){g[a]=function(){return h++,g._socket.emit("call",{Id:h,fnName:a,args:Array.prototype.slice.call(arguments,0)}),1==h&&s.onBatchStarts(h),s.onCall(h),l[h]=b.defer(),l[h].promise}}),g._loadDef.resolve(g),f!==!1&&(a.$apply(),e.cDate=new Date,d(c(e.name),e))},q=function(a,b){a._socket=io.connect(e+"/rpc-"+b).on("return",function(a){l[a.Id].resolve(a.value),n(a.Id)}).on("error",function(a){a&&a.Id?(l[a.Id].reject(a.reason),n(a.Id)):console.error("Unknown error occured on RPC socket connection")}).on("connect_failed",function(b){console.error("unable to connect to namespace ",b),a._loadDef.reject(b)}).on("disconnect",function(){delete j[b],console.warn("Server channel "+b+" disconnected.")})},r=function(c,d){return!f&&c?(e=c,f=io.connect(c+"/rpc-master",d).on("serverRunDate",function(b){m.resolve(b),a.$apply()}).on("authenticated",function(a){var b=a.name,c=j[b];q(c,b),p(c.cached,!1)}).on("channelFns",function(a,b){var c=a.name,d=j[c];q(d,c),p(a,b)}).on("channelDoesNotExist",function(b){var c=j[b.name];c._loadDef.reject(),console.warn("no channel under name: "+b.name),a.$apply()}).on("client channel created",function(a){var c=k[a],d=io.connect(e+"/rpcC-"+a+"/"+f.socket.sessionid);c._socket=d,d.on("call",function(a){var e=c.fns;if(e.hasOwnProperty(a.fnName)&&"function"==typeof e[a.fnName]){var f=e[a.fnName].apply(this,a.args);b.when(f).then(function(b){b instanceof Error?d.emit("error",{Id:a.Id,reason:b.toString()}):d.emit("return",{Id:a.Id,value:b})},function(b){b instanceof Error&&(b=b.toString()),d.emit("error",{Id:a.Id,reason:b})})}else d.emit("error",{Id:a.Id,reason:"no such function has been exposed: "+a.fnName})}),c.deferred.resolve(c)})):(console.warn("ignoring connect command, either url of master null or already connected"),void 0)},s={connect:r,loadAllChannels:function(){return f?(f.__channelListLoad=b.defer(),f.emit("load channelList"),f.on("channels",function(b){for(var c=b.list.pop();c;)j[c]={},o(c),c=b.list.pop();f.__channelListLoad.resolve(j),a.$apply()}),f.__channelListLoad.promise):(console.error("no connection to master"),void 0)},loadChannel:function(a,c){if(j.hasOwnProperty(a))return j[a]._loadDef.promise;var d=b.defer();return o(a,c,d),d.promise},expose:function(a,c){k.hasOwnProperty(a)||(k[a]={});var d=k[a];d.fns=c,d.deferred=b.defer();var e=[];for(var g in c){if("_socket"===g)throw new Error("Failed to expose channel, _socket property is reserved for socket namespace");e.push(g)}return f.emit("expose channel",{name:a,fns:e}),d.deferred.promise}},t=angular.noop;return s.onBatchStarts=t,s.onBatchEnd=t,s.onCall=t,s.onEnd=t,s.auth={},s}]).directive("rpcController",["$controller","$q","$rpc",function(a,b,c){return{scope:!0,compile:function(){return{pre:function(d,e,f){var g=f.rpcController,h=function(b){b.then(function(b){d.rpc=b;var c=a(g,{$scope:d});e.children().data("$ngControllerController",c)},function(){console.error("Cannot instantiate rpc-controller - channel failed to load")})};if(f.rpcAuth){var i=c.auth[f.rpcAuth];if("function"!=typeof i)throw new Error("no auth getter function found under "+f.rpcAuth);b.when(i()).then(function(a){var b=c.loadChannel(f.rpcChannel,a);h(b)})}else{var j=c.loadChannel(f.rpcChannel);h(j)}}}}}}]),angular.module("Moonridge",["RPC"]).factory("$MR",["$rootScope","$rpc","$q","$log",function(a,b,c,d){var e={},f=["all","and","box","center","centerSphere","circle","comment","count","elemMatch","equals","exists","find","findOne","geometry","gt","gte","hint","in","intersects","limit","lt","lte","maxDistance","maxScan","mod","ne","near","nearSphere","nin","nor","or","polygon","populate","read","regex","select","size","skip","slice","sort","where","within"],g=function(g,h){function i(){var b=this,e=0;this._LQs={},this._LQsByQuery={},this.deferred=c.defer(),this.liveQuery=function(c){var g={};g.docs=[],Object.defineProperty(g,"doc",{enumerable:!1,configurable:!1,get:function(){return g.docs[0]}}),g.count=0,g._query=c||{},g.getDocById=function(a){for(var b=g.docs.length;b--;)if(g.docs[b]._id===a)return g.docs[b];return null},g.recountIfNormalQuery=function(){g._query.count||(g.count=g.docs.length)},g.on_create=function(a,b){return g._query.count?(g.count+=1,void 0):(angular.isNumber(b)?g.docs.splice(b,0,a):g.docs.push(a),g._query.limit<g.docs.length&&g.docs.splice(g.docs.length-1,1),g.recountIfNormalQuery(),void 0)},g.on_push=g.on_create,g.on_update=function(a,b){if(g._query.count)return angular.isNumber(b)?g.count+=1:(b===!1&&(g.count-=1),b===!0&&(g.count+=1)),void 0;for(var c=g.docs.length;c--;){var e;if(g.docs[c]._id===a._id)return b===!1?(g.docs.splice(c,1),void 0):(angular.isNumber(b)?b!==c?b>c?(g.docs.splice(c,1),g.docs.splice(b-1,0,a)):(g.docs.splice(c,1),g.docs.splice(b,0,a)):(e=g.docs[c],angular.extend(e,a)):(e=g.docs[c],angular.extend(e,a)),void 0)}return b?(angular.isNumber(b)?g.docs.splice(b,0,a):g.docs.push(a),void 0):(d.error("Failed to find updated document."),g.recountIfNormalQuery(),void 0)},g.on_remove=function(a){if(g._query.count)return g.count-=1,void 0;for(var b=g.docs.length;b--;)if(g.docs[b]._id===a)return g.docs.splice(b,1),g.count-=1,!0;return d.error("Failed to find deleted document."),!1},g.stop=function(){if(!angular.isNumber(g.index)||!b._LQs[g.index])throw new Error("There must be a valid index property, when stop is called");b.rpc.unsubLQ(g.index).then(function(a){a&&(g.unsubscribed=!0,g._query.count?g.count=0:(g.doc=null,g.docs=[]),delete b._LQs[g.index],delete b._LQsByQuery[g._queryStringified])})};var h=function(){var c=this;this.exec=function(){if(g._query.hasOwnProperty("count")&&g._query.hasOwnProperty("sort"))throw new Error("count and sort must NOT be used on the same query");if(g._queryStringified=JSON.stringify(g._query),b._LQsByQuery[g._queryStringified])return b._LQsByQuery[g._queryStringified];b._LQsByQuery[g._queryStringified]=g;var c=function(){g.promise=g.promise.then(function(a){if(g._waitingOnFirstResponse===!0&&(g._waitingOnFirstResponse=!1),angular.isNumber(a.count))g.count=a.count;else{var b=a.docs.length;for(g.count=b;b--;)g.docs[b]=a.docs[b]}return g},function(a){d.error(a)})};return g._waitingOnFirstResponse=!0,e+=1,b._LQs[e]=g,g.index=e,g.promise=b.rpc.liveQuery(g._query,g.index),a.$watch(function(){return g._query},function(a){angular.isUndefined(a)||(g._waitingOnFirstResponse||(g.stop&&g.stop(),g.promise=b.rpc.liveQuery(a)),c())},!0),g};var h=Array.prototype.slice;f.forEach(function(a){c[a]=function(){var b=g._query;if(b.hasOwnProperty(a))if("object"==typeof b[a]){var d=Object.keys(b).length;b[a][d]=h.call(arguments)}else b[a]={0:b[a],1:h.call(arguments)};else b[a]=h.call(arguments);return c}})},i=new h;return i}}var j;if(e[g])return e[g];j={},e[g]=j;var k={};return j.connectPromise=c.when(h).then(function(a){return j.socket=b.connect(a.url,a.hs),j.socket}),j.getAllModels=function(){b.loadChannel("Moonridge").then(function(a){a.getModels().then(function(){})})},j.getModel=function(a,e){var f=k[a];return f?f.deferred.promise:(f=new i,k[a]=f,j.connectPromise.then(function(){var g={client:b.expose("MR-"+a,{pub:function(){},pubLQ:function(a,b,c,e){f._LQs[c]?f._LQs[c]["on_"+b](a,e):d.error("Unknown liveQuery calls this clients pub method, LQ id: "+c)}}),server:b.loadChannel("MR-"+a,e)};c.all(g).then(function(a){f.rpc=a.server,f.deferred.resolve(f)})}),f.update=function(a){return delete a.__v,f.rpc.update(a)},f.create=function(a){return f.rpc.create(a)},f.remove=function(a){return f.rpc.remove(a._id)},f.deferred.promise)},j};return g.getBackend=function(a){if(e[a])return e[a];throw new Error("no such Moonridge backend")},g}]).directive("mrController",["$controller","$q","$MR",function(a,b,c){return{scope:!0,compile:function(){return{pre:function(d,e,f){var g=f.mrController,h=f.mrBackend,i=c.getBackend(h),j=function(b){d.MR=b,d.$on("$destroy",function(){});var c=a(g,{$scope:d});e.children().data("$ngControllerController",c)},k=function(a){throw new Error("Cannot instantiate mr-controller - error: "+a)};if(f.mrModel)i.getModel(f.mrModel).then(j,k);else if(f.mrModels){var l=f.mrModels.split(","),m={};l.forEach(function(a){m[a]=i.getModel(a)}),b.all(m).then(j,k)}}}}}}]).directive("mrRepeat",["$controller","$q","$MR",function(){return{compile:function(a){var b=a.attr("mr-repeat");return a.attr("ng-repeat",b+".docs"),{pre:function(a){a[b]}}}}}]);