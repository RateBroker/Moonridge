angular.module("RPC",[]).factory("$rpc",["$rootScope","$q",function(a,b){function c(a){return"SIORPC:"+e+"/"+a}function d(a,b){try{localStorage[a]=JSON.stringify(b)}catch(c){console.warn("Error raised when writing to local storage: "+c)}}var e,f,g,h=0,i=0,j={},k={},l=[],m={},n=b.defer();n.promise.then(function(a){g=new Date(a)});var o=function(a){l[a]?(delete l[a],i++,t.onEnd(i),i==h&&(t.onBatchEnd(i),h=0,i=0)):console.warn("Deferred Id "+a+" was resolved/rejected more than once, this should not occur.")},p=function(a,b,d){j.hasOwnProperty(a)||(j[a]={});var e=j[a];return e._loadDef=d,n.promise.then(function(){var d=c(a),h=localStorage[d];h?(h=JSON.parse(h),g<new Date(h.cDate)?b?(f.emit("authenticate",{name:a,handshake:b}),e.cached=h):(r(e,a),q(h,!1)):(delete localStorage[d],f.emit("load channel",{name:a,handshake:b}))):f.emit("load channel",{name:a,handshake:b})}),e._loadDef.promise},q=function(e,f){var g=j[e.name],i=function(a){g[a]=function(){return h++,g._socket.emit("call",{Id:h,fnName:a,args:Array.prototype.slice.call(arguments,0)}),1==h&&t.onBatchStarts(h),t.onCall(h),l[h]=b.defer(),l[h].promise}};e.fnNames?(e.tplId&&(m[e.tplId]=e.fnNames),e.fnNames.forEach(i)):m[e.tplId].forEach(i),g._loadDef.resolve(g),f!==!1&&(a.$apply(),e.cDate=new Date,d(c(e.name),e))},r=function(a,b){a._socket=io.connect(e+"/rpc-"+b).on("return",function(a){l[a.Id].resolve(a.value),o(a.Id)}).on("error",function(a){a&&a.Id?(l[a.Id].reject(a.reason),o(a.Id)):console.error("Unknown error occured on RPC socket connection")}).on("connect_failed",function(b){console.error("unable to connect to namespace ",b),a._loadDef.reject(b)}).on("disconnect",function(){delete j[b],console.warn("Server channel "+b+" disconnected.")})},s=function(c,d){return!f&&c?(e=c,f=io.connect(c+"/rpc-master",d).on("serverRunDate",function(b){n.resolve(b),a.$apply()}).on("authenticated",function(a){var b=a.name,c=j[b];r(c,b),q(c.cached,!1)}).on("channelFns",function(a,b){var c=a.name,d=j[c];r(d,c),q(a,b)}).on("channelDoesNotExist",function(b){var c=j[b.name];c._loadDef.reject(),console.warn("no channel under name: "+b.name),a.$apply()}).on("client channel created",function(a){var c=k[a],d=io.connect(e+"/rpcC-"+a+"/"+f.io.engine.id);c._socket=d,d.on("call",function(a){var e=c.fns;if(e.hasOwnProperty(a.fnName)&&"function"==typeof e[a.fnName]){var f=e[a.fnName].apply(this,a.args);b.when(f).then(function(b){b instanceof Error?d.emit("error",{Id:a.Id,reason:b.toString()}):d.emit("return",{Id:a.Id,value:b})},function(b){b instanceof Error&&(b=b.toString()),d.emit("error",{Id:a.Id,reason:b})})}else d.emit("error",{Id:a.Id,reason:"no such function has been exposed: "+a.fnName})}),c.deferred.resolve(c)})):void console.warn("ignoring connect command, either url of master null or already connected")},t={connect:s,loadAllChannels:function(){return f?(f.__channelListLoad=b.defer(),f.emit("load channelList"),f.on("channels",function(b){for(var c=b.list.pop();c;)j[c]={},p(c),c=b.list.pop();f.__channelListLoad.resolve(j),a.$apply()}),f.__channelListLoad.promise):void console.error("no connection to master")},loadChannel:function(a,c){if(j.hasOwnProperty(a))return j[a]._loadDef.promise;var d=b.defer();return p(a,c,d),d.promise},expose:function(a,c){k.hasOwnProperty(a)||(k[a]={});var d=k[a];d.fns=c,d.deferred=b.defer();var e=[];for(var g in c){if("_socket"===g)throw new Error("Failed to expose channel, _socket property is reserved for socket namespace");e.push(g)}return f.emit("expose channel",{name:a,fns:e}),d.deferred.promise}},u=angular.noop;return t.onBatchStarts=u,t.onBatchEnd=u,t.onCall=u,t.onEnd=u,t.auth={},t}]).directive("rpcController",["$controller","$q","$rpc",function(a,b,c){return{scope:!0,compile:function(){return{pre:function(d,e,f){if(!f.rpcChannel)throw new Error("No channel name defined on rpc-controller element: "+e[0].outerHTML);var g=f.rpcController,h=function(b){b.then(function(b){var c={$scope:d};c[f.rpcChannel]=b;var h=a(g,c);e.children().data("$ngControllerController",h)},function(){console.error("Cannot instantiate rpc-controller - channel failed to load")})};if(f.rpcAuth){var i=c.auth[f.rpcAuth];if("function"!=typeof i)throw new Error("no auth getter function found under "+f.rpcAuth);b.when(i()).then(function(a){var b=c.loadChannel(f.rpcChannel,a);h(b)})}else{var j=c.loadChannel(f.rpcChannel);h(j)}}}}}}]),angular.module("Moonridge",["RPC"]).factory("$MR",["$rootScope","$rpc","$q","$log","MRMethodsClientValidations",function(a,b,c,d,e){var f,g={},h=["findOne","select","count","sort","limit","skip"],i=function(a,i,j){function k(a){return d.error(a),c.reject(a)}function l(a){var b=this,e=0;this.name=a,this._LQs={},this._LQsByQuery={},this.deferred=c.defer(),this.update=function(a){return delete a.__v,delete a.$$hashKey,b.rpc.update(a).catch(k)},this.create=function(a){return delete a.$$hashKey,b.rpc.create(a).catch(k)},this.remove=function(a){return b.rpc.remove(a._id).catch(k)},this.listPaths=function(){return b.rpc.listPaths().catch(k)},this.query=function(){var a={query:[],indexedByMethods:{}},c=new o(a,function(){return b.rpc.query(a.query)},b);return c};var f=function(a){return function(c,e,f){var g=b._LQs[c];g?(g["on_"+a](e,f),g._invokeListeners(a,arguments)):d.error("Unknown liveQuery calls this clients pub method, LQ id: "+c)}};this.clientRPCMethods={update:f("update"),remove:f("remove"),create:f("create"),push:f("push")},this.liveQuery=function(a){a&&a.stop();var c={_model:b},f={update:[],remove:[],create:[],push:[],init:[],any:[]};c._invokeListeners=function(a,b){"any"!==a&&this._invokeListeners("any",b);for(var d=f[a].length;d--;)f[a][d].call(c,b)},c.on=function(a,b){return f[a].push(b)-1},c.off=function(a,b){return f[a][b]?(delete f[a][b],!0):!1},c.docs=[],-1===navigator.userAgent.indexOf("MSIE 8.0")&&Object.defineProperty(c,"doc",{enumerable:!1,configurable:!1,get:function(){return c.docs[0]}}),c.count=0,angular.isObject(a)?(c.query=a.query,c.indexedByMethods=a.indexedByMethods):(c.query=[],c.indexedByMethods={}),c.getDocById=function(a){for(var b=c.docs.length;b--;)if(c.docs[b]._id===a)return c.docs[b];return null},c.recountIfNormalQuery=function(){c.indexedByMethods.count||(c.count=c.docs.length)},c.on_create=function(a,b){return c.indexedByMethods.count?void(c.count+=1):(angular.isNumber(b)?c.docs.splice(b,0,a):c.docs.push(a),c.indexedByMethods.limit<c.docs.length&&c.docs.splice(c.docs.length-1,1),void c.recountIfNormalQuery())},c.on_push=c.on_create,c.on_update=function(a,b){if(c.indexedByMethods.count)return void(angular.isNumber(b)?c.count+=1:(b===!1&&(c.count-=1),b===!0&&(c.count+=1)));for(var e=c.docs.length;e--;){var f;if(c.docs[e]._id===a._id)return b===!1?void c.docs.splice(e,1):void(angular.isNumber(b)&&b!==e?b>e?(c.docs.splice(e,1),c.docs.splice(b-1,0,a)):(c.docs.splice(e,1),c.docs.splice(b,0,a)):(f=c.docs[e],angular.extend(f,a)))}return b?void(angular.isNumber(b)?c.docs.splice(b,0,a):c.docs.push(a)):(d.error("Failed to find updated document."),void c.recountIfNormalQuery())},c.on_remove=function(a){if(c.indexedByMethods.count)return c.count-=1,!0;for(var b=c.docs.length;b--;)if(c.docs[b]._id===a)return c.docs.splice(b,1),c.count-=1,!0;return d.error("Failed to find deleted document."),!1},c.stop=function(){if(!angular.isNumber(c.index)||!b._LQs[c.index])throw new Error("There must be a valid index property, when stop is called");c.stopped=!0,b.rpc.unsubLQ(c.index).then(function(a){a&&(c.indexedByMethods.count?c.count=0:(c.doc=null,c.docs=[]),delete b._LQs[c.index],delete b._LQsByQuery[c._queryStringified])})};var g=function(){if(c.indexedByMethods.hasOwnProperty("count")&&c.indexedByMethods.hasOwnProperty("sort"))throw new Error("count and sort must NOT be used on the same query");return c._queryStringified=JSON.stringify(c.query),b._LQsByQuery[c._queryStringified]&&b._LQsByQuery[c._queryStringified].stopped!==!0?b._LQsByQuery[c._queryStringified]:(b._LQsByQuery[c._queryStringified]=c,e+=1,b._LQs[e]=c,c.index=e,c.promise=b.rpc.liveQuery(c.query,c.index).then(function(a){if(angular.isNumber(a.count))c.count=a.count;else{var b=a.docs.length;for(c.count=b;b--;)c.docs[b]=a.docs[b]}return c._invokeListeners("init",a),c},k),c)},h=new o(c,g,b);return h}}var m;if(g[a])return g[a];m={},g[a]=m;var n={};m.connectPromise=c.when(i).then(function(a){return m.socket=b.connect(a.url,a.hs),m.socket}),m.getAllModels=function(){b.loadChannel("Moonridge").then(function(a){a.getModels().then(function(){})})};var o=function(a,b,c){var d=this;this.exec=b,this._model=c;var f=Array.prototype.slice,g=function(b){d[b]=function(){var c=f.call(arguments),g=e[b](c);if(g instanceof Error)throw g;var i=a.query;if(-1!==h.indexOf(b)){if(a.indexedByMethods[b])for(var j=i.length;j--;)i[j].mN===b&&i.splice(j,1);a.indexedByMethods[b]=c}return i.push({mN:b,args:c}),d}};for(var i in e)g(i)};return m.getModel=function(a,d){var e=n[a];return e?e.deferred.promise:(e=new l(a),n[a]=e,m.connectPromise.then(function(){var f={client:b.expose("MR-"+a,e.clientRPCMethods),server:b.loadChannel("MR-"+a,d)};c.all(f).then(function(a){e.rpc=a.server,e.deferred.resolve(e)})}),e.deferred.promise)},m.getModels=function(a,b){for(var d={},e=a.length;e--;){var f=a[e];d[f]=m.getModel(f,b)}return c.all(d)},j&&(f=m),m};return i.getBackend=function(a){if(g[a])return g[a];throw new Error("no such Moonridge backend")},i.getDefaultBackend=function(){return f},i}]).directive("mrController",["$controller","$q","$MR",function(a,b,c){var d=function(a){throw new Error("Cannot instantiate mr-controller - error: "+a)};return{scope:!0,compile:function(){return{pre:function(b,e,f){var g,h=f.mrController;g=f.mrBackend?c.getBackend(f.mrBackend):c.getDefaultBackend();var i=function(c){b.$on("$destroy",function(){});var d={$scope:b},g="models";f.mrModel&&(g=f.mrModel),d[g]=c;var i=a(h,d);e.children().data("$ngControllerController",i)};if(f.mrModel&&void 0===f.mrModels)g.getModel(f.mrModel).then(i,d);else{if(!f.mrModels||void 0!==f.mrModel){var j=e[0].outerHTML;throw new Error(f.mrModels&&f.mrModel?"Cannot have both mr-model and mr-models attributes defined on element: "+j:"No Moonridge models defined on element: "+j)}var k=f.mrModels.split(",");g.getModels(k).then(i,d)}}}}}}]).directive("mrRepeat",["$compile","mrSpinner",function(a,b){return{compile:function(c){var d=c.html();return c.html(b),function(b,c,e){function f(f){c.removeAttr("mr-repeat"),g?c.attr("ng-repeat",h+".docs"):(c.attr("ng-repeat",h),b[i]=f),c.html(d),a(c)(b),g&&!e.noStopping&&b.$on("$destroy",function(){g.stop()})}var g,h=e.mrRepeat,i=h.split("in ")[1];b.$watch(i,function(a){a&&(a.promise?(g=a,a.promise.then(f)):a.then&&a.then(f))})}}}}]).value("mrSpinner",'<div class="spinner"><div class="rect1"></div><div class="rect2"></div><div class="rect3"></div><div class="rect4"></div><div class="rect5"></div></div>'),angular.module("Moonridge").factory("MRMethodsClientValidations",function(){function a(a){return"number"==typeof a&&a%1==0}var b=function(){return!0},c=function(b){return 1===b.length?a(b[0])?!0:new TypeError("Argument must be an integer"):new Error("Method must be called with exactly one Number argument")},d={all:b,and:b,box:b,center:b,centerSphere:b,circle:b,comment:b,count:b,elemMatch:b,equals:b,exists:b,find:b,findOne:function(a){return 0===a.length?!0:a.length>1?new Error("FindOne does not take more than one argument"):"object"!=typeof a[0]?new TypeError("FindOne takes just one Object as argument"):!0},geometry:b,gt:b,gte:b,hint:b,"in":b,intersects:b,limit:c,lt:b,lte:b,maxDistance:b,maxScan:c,mod:b,ne:b,near:b,nearSphere:b,nin:b,nor:b,or:b,polygon:b,populate:b,read:b,regex:b,select:b,size:b,skip:c,slice:b,sort:b,where:function(a){return a.length>0&&a.length<=2?!0:new Error("Method was called with wrong number of arguments")},within:b};return d}),angular.module("Moonridge").run(["$templateCache",function(a){"use strict";a.put("moonridge_query_dropdown.html",'<div class="moonridge-query-dropdown btn-group">\r\n    <a class="btn btn-default dropdown-toggle" data-toggle="dropdown">\r\n        Sort and filter <span class="caret"></span>\r\n    </a>\r\n    <ul class="dropdown-menu" role="menu">\r\n        <li ng-repeat="path in paths">\r\n            <div class="row" ng-if="mrDropdown_guiPathTexts[$index] !== false">\r\n                <div class="col-md-4">\r\n                    <span ng-class="{active: getSortTokens().indexOf(\'-\' + path) !== -1}"\r\n                            class="glyphicon glyphicon-sort-by-attributes-alt" ng-click="sortBy(\'-\' + path, $event)"></span>\r\n                    <span ng-class="{active: getSortTokens().indexOf(path) !== -1}"\r\n                            class="glyphicon glyphicon-sort-by-attributes" ng-click="sortBy(path, $event)"></span>\r\n                </div>\r\n                <div class="col-md-8">\r\n                    <a ng-bind="mrDropdown_guiPathTexts[$index] || path" ng-click="switchSort(path)"></a>\r\n                </div>\r\n            </div>\r\n        </li>\r\n    </ul>\r\n</div>')}]),angular.module("Moonridge").directive("mrQueryDropdown",function(){return{restrict:"EA",templateUrl:"moonridge_query_dropdown.html",link:function(a,b,c){var d,e=c.query;a.$watch(e,function(b){b&&b._model&&b._model.rpc&&(a.mrDropdown_guiPathTexts=a.$eval(c.guiPathTexts),d!==b._model.name&&(d=b._model.name,b._model.rpc.listPaths().then(function(b){console.log("mrQueryDropdown",b),a.paths=b}),a.getSortTokens=function(){return a[e].indexedByMethods.sort[0].split(" ")},a.sortBy=function(c,d){if(console.log(c,d),d.shiftKey);else{var f=b._model.liveQuery(a[e]);a[e]=f.sort(c).exec()}}))})}}});